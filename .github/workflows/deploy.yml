name: Deploy to Cloud Run

on:
  push:
    branches: [main, develop]

env:
  # GitHub Secrets に登録した値を自動で使います
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ブランチによって stg と prd を分ける
      - name: Set Environment
        run: |
          if [[ $GITHUB_REF == 'refs/heads/main' ]]; then
            echo "ENV_NAME=prd" >> $GITHUB_ENV
          else
            echo "ENV_NAME=stg" >> $GITHUB_ENV
          fi

      # Google Cloud 認証
      - uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # ビルドとデプロイを一気に行う
      - name: Build and Deploy
        run: |
          SERVICE_NAME=pizza-app-${{ env.ENV_NAME }}
          IMAGE_URL=gcr.io/${{ env.PROJECT_ID }}/$SERVICE_NAME:${{ github.sha }}

          # Google Cloud 上でビルドを実行（高速で確実）
          gcloud builds submit --tag $IMAGE_URL .

          # Cloud Run へデプロイ
          gcloud run deploy $SERVICE_NAME \
            --image $IMAGE_URL \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 0 \
            --port 3000 # Next.jsのデフォルトに合わせて3000にしていますが、Dockerfileの設定に合わせてください